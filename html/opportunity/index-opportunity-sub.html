<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.picker.css" />
		<link rel="stylesheet" type="text/css" href="../../css/mui.poppicker.css" />
		<link rel="stylesheet" type="text/css" href="../../css/icons-extra.css" />
		<style>
			
			
			.mui-input-row {
				line-height: 25px;
			}
			.img-avatar {
				float: left;
				padding-bottom: 5px;
				margin-left: 0px;
				padding-bottom: 5px;
			}
			.mui-table-view:before {
				height: 0px;
			}
			
			.oppor-scroll-wrapper .mui-card{
				margin:8px;
			}
			.oppor-scroll .mui-card-header{
				padding-left:20px;
				padding-right:20px;
				border-bottom: 1px dashed #E4E4E4;
				height: 45px;
			}
			
			.oppor-scroll .mui-card-header:after{
				height: 0;
			}
			.oppor-scroll .mui-table-view .mui-table-view-cell:not(:first-child){
				font-size: 12px;
			}
			
			.oppor-scroll .mui-table-view .mui-table-view-cell:first-child{
				color: #212121;
				padding-top: 16px;
				font-weight: 600;
				
			}
			var{
				line-height: 20px;
			}
			
			.oppor-scroll .mui-table-view .mui-table-view-cell:last-child{
				color: #618DF6 ;
			}
			
			.mui-table-view-cell:after {
				height: 0px;
			}
			.mui-table-view-cell var:not(:first-child):not(:last-child){
				padding-left:5px;
				padding-right: 5px;
			}
			.second-cell var:not(:last-child){
				color: #666666;
			}
			.second-cell var:last-child{
				color: #444444;
			}
		</style>
	</head>

	<body>
		<!--下拉刷新容器-->
		
		<div id="pullrefresh" class="mui-scroll-wrapper oppor-scroll-wrapper">
			<div class="mui-scroll oppor-scroll" style="margin-top: 0px;">
				<!--数据列表-->
				<div class="mui-card clear" data-opporId="1">
					<div class="mui-card-header">
						<label>客流编号 1</label>
						<span>接待中</span>
					</div>
					<div class="mui-card-content">
						<ul class="mui-table-view">
							<li class="mui-table-view-cell">
								<var >李小姐</var>
								<var >女</var>
								<var >13112346543</var>
								<var class="mui-pull-right">汽车之家</var>
							</li>
							<li class="mui-table-view-cell second-cell">
								<var>H级别</var>
								<var>2018-08-20 10:10:10</var>
								<var class="mui-pull-right">奥迪A6</var>
							</li>
							<li class="mui-table-view-cell">
								<i class="mui-icon-extra mui-icon-extra-outline active"></i>
								<var class="active">
									剩余时间2小时15分
								</var>
							</li>
						</ul>
					</div>
				</div>
				
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/common.js"></script>
		<script src="../../js/common/base64.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/mui.picker.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/mui.poppicker.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/common/select.data.js" type="text/javascript" charset="utf-8"></script>

		<script>
			mui.init({
				pullRefresh: {
					container: '#pullrefresh',
					down: {
						callback: pulldownRefresh
					},
					up: {
						contentrefresh: '正在加载...',
						callback: pullupRefresh
					}
				}
			});
			//TODO 从localstorage中获取persId
//			var belongsPersId = '4ea8ab447c0a446ba32985d687b7e78b';
//			var belongsPersId = localStorage.getItem("persId");
			//查询参数
			var status = '';
			var jobId = '';
			var modifyDate = '';

			//存储列表查询结果
			var progressLib = null;
			//查询参数签名
			var preSign = '';
			//上拉次数判断参数
			var count = 0;

			/**
			 * 下拉刷新具体业务实现
			 */
			function pulldownRefresh() {
				setTimeout(function() {
//					console.log("下拉刷新");
//					var table = document.body.querySelector('.mui-table-view');
//					var cells = document.body.querySelectorAll('.mui-table-view-cell');
//
////					qryDataList(belongsPersId, [], function(data) {
////						if(data.success) {
////							//成功返回数据，
////							progressLib = data.data;
////							//1.清空原ul下的子节点全部清空
////							while(table.hasChildNodes()) {
////								console.log('清理列表数据...');
////								table.removeChild(table.firstChild);
////							}
////							count = 0;
////							//2.将数据前10条填充到列表中
////							fillingData("pulldown");
////							
////						} else {
////							plus.nativeUI.toast(data.error);
////						}
////
////					});
//					fillingData("pulldown");
					mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
				}, 1500);
			}

			/**
			 * 上拉加载具体业务实现
			 */
			function pullupRefresh() {

				setTimeout(function() {
//					//组装查询参数
////					var params = {
////						'status': status,
////						'jobId': jobId,
////						'modifyDate': modifyDate
////					};
////
////					var currentSign = Base64.encode(JSON.stringify(params));
////
////					if(preSign != currentSign) {
////						console.log('查询条件改变');
////						//查询条件改变时，需要查询数据库，清理页面节点，重新渲染页面
////						//TODO 从localstorage中获取persId
////						qryDataList(belongsPersId, params, function(data) {
////							if(data.success) {
////								//更新数据
////								progressLib = data.data;
////								preSign = currentSign;
////								count = 0;
////
////								fillingData("pullup");
////							} else {
////								plus.nativeUI.toast(data.error);
////							}
////						});
////					} else {
////						//条件未变的情况下
////						fillingData("pullup");
////					}
//					fillingData("pullup");
//
				}, 1500);

			}

			//###############进行页面渲染#################
//			function fillingData(pull) {
//
//				var table = document.body.querySelector('.mui-table-view');
//				var cells = document.body.querySelectorAll('.mui-table-view-cell');
//				
////				var progressLibLen = progressLib.length;
//				var progressLibLen = 6;
//				if(pull == "pullup"){
//					mui('#pullrefresh').pullRefresh().endPullupToRefresh((++count > Math.ceil(progressLib.length / 4))); //参数为true代表没有更多数据了。
//				}
//				
//				
//
//				var i = cells.length;
//				var len = null;
//				if((cells.length + 4 > progressLibLen) && (cells.length - 4 < progressLibLen)) {
//					len = progressLibLen;
//				} else {
//					len = i + 4;
//				}
//				for(; i < len; i++) {
////					var resources = progressLib[i].resources;
////					var resources = progressLib[i].resources;
////
//					var sex = progressLib[i].persSex;
//					var date = new Date(progressLib[i].updateTime);
//					
//					var hours = date.getHours();
//					if(hours<10){
//						hours = '0'+hours;
//					}
//					var minutes = date.getMinutes();
//					if(minutes<10){
//						minutes = '0'+minutes;
//					}
//					var seconds = date.getSeconds();
//					if(seconds<10){
//						seconds = '0'+seconds;
//					}
//					var dateStr = date.getFullYear() + "/" + (date.getMonth() + 1) + "/" + date.getDate() + " " + hours + ":" + minutes + ":" + seconds;
//
//					var li = document.createElement('li');
//					li.className = 'mui-table-view-cell';
//					li.setAttribute("data-processid", progressLib[i].id);
//					li.setAttribute("data-status", progressLib[i].persStatus);
//					var item = '<div class="mui-table"><div class="mui-table-row">\
//								<div class="mui-input-row mui-col-xs-12 mui-col-sm-12">\
//								<span style="font-size: 18px;color: #000000;font-weight: bold; padding-right: 25px;">' + progressLib[i].persName + '</span>';
//					if(sex == '01') {
//						item += '<img style="width: 12px;" src="../../image/icon_man.png">';
//					} else {
//						item += '<img style="width: 11px;" src="../../image/icon_woman.png">';
//					}
//					item += '<span style="font-size: 15px;color: #000000;padding-left:5px;">' + progressLib[i].persAge + '岁</span>\
//							<span style="font-size: 15px;color: #10b96d;float: right;">' + progressLib[i].persMobile + '</span>\
//								</div>\
//								<div class="mui-input-row mui-col-xs-12 mui-col-sm-12" style="font-size: 15px;">\
//								<div id="progressBar"><div class="progressBar"><span></span></div>\
//								<div class="progressBar"><span></span></div>\
//								<div class="course_nr course_nr_1"><div class="mui-checkbox">';
//					if(progressLib[i].persStatus == '04' || progressLib[i].persStatus == '05') {
//						item += '<input name="checkbox" type="checkbox" checked class="active" disabled>';
//					} else {
//						item += '<input name="checkbox" type="checkbox" checked disabled>';
//					}
//					item += '</div><span class="desc">已报名</span></div>\
//								<div class="course_nr course_nr_2"><div class="mui-checkbox">';
//					if(progressLib[i].persStatus == '06' || progressLib[i].persStatus == '07') {
//						item += '<input name="checkbox" type="checkbox" checked class="active" disabled>';
//					} else {
//						item += '<input name="checkbox" type="checkbox" checked disabled>';
//					}
//					item += '</div><span class="desc">已面试</span></div>\
//								<div class="course_nr course_nr_3"><div class="mui-checkbox">';
//					if(progressLib[i].persStatus == '08') {
//						item += '<input name="checkbox" type="checkbox" checked class="active" disabled>';
//					} else {
//						item += '<input name="checkbox" type="checkbox" checked disabled>';
//					}
//					item += '</div><span class="desc">已入职</span></div></div></div>\
//								<div class="mui-input-row mui-col-xs-12 mui-col-sm-12" style="font-size: 15px;">\
//								<span class="mui-pull-left" style="color: #000000;">' + dateStr + '</span>\
//								<span style="color: #ff7300;font-weight: bold;">&#12288 ' + progressLib[i].statusVal + '</span></div>\
//								<div class="mui-input-row mui-col-xs-12 mui-col-sm-12" style="font-size: 15px;">\
//								<span style="font-size: 15px;">' + progressLib[i].corpJobName + '</span>\
//								</div></div></div>';
//
//					li.innerHTML = item;
//					//下拉刷新，新纪录插到最前面；
//					if(pull=="pullup"){
//						table.appendChild(li);
//					}else{
//						//下拉刷新，新纪录插到最前面；
//						table.insertBefore(li, table.firstChild);
//					}
//					
//					
//				}
//				
//				console.log('<<<<数据填充');
//				showProgressDetail();
//			}

			//###########数据列表查询函数#############
//			function qryDataList(belongsPersId, params, fn) {
//
//				params = params || {};
//				var qryUrl = common.URL.qryProcessListByParams(belongsPersId);
//
//				mui.ajax(qryUrl, {
//					data: params,
//					async: false, //发送同步请求
//					dataType: 'json', //服务器返回json格式数据
//					type: 'get', //HTTP请求类型
//					timeout: 10000, //超时时间设置为10秒；
//					success: fn,
//					error: function(xhr, type, errorThrown) {
//						//异常处理；
//						plus.nativeUI.toast('哎哟，出错了，请稍后再试！');
//					}
//				});
//			}
			//###################################
			
			

//			function showJobOption() {
//				var titleText = '';
//				jobPicker.show(function(items) {
//					titleText = (items[0] || {}).text;
//					jobId = (items[0] || {}).value;
//					mui.fire(plus.webview.getWebviewById('job-progress'), 'showJob', {
//						value: titleText
//					});
//					dealNode();
//					mui('#pullrefresh').pullRefresh().pullupLoading();
//				});
//			}

			//取消按钮，开启滚动
//			jobPicker.cancel.addEventListener('tap', function(event) {
//
//				mui.fire(plus.webview.getWebviewById('job-progress'), 'showJob', {
//					value: ''
//				});
//
//			}, false);

//			function showDateOption() {
//				var titleText = '';
//				datePicker.show(function(items) {
//					titleText = (items[0] || {}).text;
//					modifyDate = (items[0] || {}).value;
//					mui.fire(plus.webview.getWebviewById('job-progress'), 'showDate', {
//						value: titleText
//					});
//					dealNode();
//					mui('#pullrefresh').pullRefresh().pullupLoading();
//				});
//			}
//
//			//取消按钮，开启滚动
//			datePicker.cancel.addEventListener('tap', function(event) {
//
//				mui.fire(plus.webview.getWebviewById('job-progress'), 'showDate', {
//					value: ''
//				});
//
//			}, false);
//
//			//清理原ul下的所有子节点
//			function dealNode() {
//				var table = document.body.querySelector('.mui-table-view');
//				//清理table下子节点信息
//				while(table.hasChildNodes()) {
//					table.removeChild(table.lastChild);
//				}
//			}
			var detailPage = "";
			//下拉刷新初始化动作	
			if(mui.os.plus) {
				mui.plusReady(function() {
//					showProgressCount();
//					showJobList();

					setTimeout(function() {
						mui('#pullrefresh').pullRefresh().pullupLoading();
					}, 1000);
					
					/*预加载详情页*/
					detailPage = mui.preload({
						url:'opportunity-detail.html',
						id:'opporDetail',//默认使用当前页面的url作为id
					});
					
					showOpporDetail();

				});
			} else {
				mui.ready(function() {
//					showProgressCount();
//					showJobList();
					mui('#pullrefresh').pullRefresh().pullupLoading();
				});
				/*预加载详情页*/
					detailPage = mui.preload({
						url:'opportunity-detail.html',
						id:'opporDetail',//默认使用当前页面的url作为id
					});
					
					showOpporDetail();
			}

//			function showProgressDetail() {
//				mui('.mui-table-view').on('tap', 'li', function() {
//					var processid = this.getAttribute("data-processid");
//					var status = this.getAttribute("data-status");
//					//						var resourceid = this.getAttribute("data-resourceid");
//					//						var persid = this.getAttribute("data-persid");
//					//						alert(statusVal);
//					//打开关于页面
//					mui.openWindow({
//						url: 'job-progress-detail.html',
//						id: "progressDetail", //默认使用当前页面的url作为id
//						//							styles: {//窗口参数
//						//								popGesture: 'hide',
//						//								top:45
//						//							},
//						extras: {
//							processid: processid,
//							status: status
//								//								resourceid:resourceid,
//								//								persid:persid
//						}, //自定义扩展参数
//						createNew: false //是否重复创建同样id的webview，默认为false:不重复创建，直接显示
//					})
//				})
//			}

//			function showProgressCount() {
//				//TODO 从localstorage中获取persId
//				var qryUrl = common.URL.qryProcessListCount(belongsPersId);
//
//				mui.ajax(qryUrl, {
//					dataType: 'json', //服务器返回json格式数据
//					type: 'get', //HTTP请求类型
//					timeout: 10000, //超时时间设置为10秒；
//					success: function(data) {
//						var processCount = data.data;
//						var applyCount = processCount.applyCount;
//						var interviewSuccessCount = processCount.interviewSuccessCount;
//						var interviewFailCount = processCount.interviewFailCount;
//						var entryCount = processCount.entrySuccessCount;
//
//						mui.fire(plus.webview.getWebviewById('job-progress'), 'showStatusCount', {
//							applyCount: applyCount,
//							interviewSuccessCount: interviewSuccessCount,
//							interviewFailCount: interviewFailCount,
//							entryCount: entryCount
//						});
//					},
//					error: function(xhr, type, errorThrown) {
//						//异常处理；
//						plus.nativeUI.toast('哎哟，出错了，请稍后再试！');
//					}
//				});
//
//			}

//			function showJobList() {
//
//				//TODO 从localstorage中获取persId
//				var qryUrl = common.URL.qryProcessJobList(belongsPersId);
//
//				mui.ajax(qryUrl, {
//					dataType: 'json', //服务器返回json格式数据
//					type: 'get', //HTTP请求类型
//					timeout: 10000, //超时时间设置为10秒；
//					success: function(data) {
//						var jobData = [{
//							value: '',
//							text: '不限'
//						}];
//						for(var i = 0; i < data.data.length; i++) {
//							var jobbean = {};
//							//职位下拉框
//							jobbean.value = data.data[i].corpJobId;
//							jobbean.text = data.data[i].jobName;
//							jobData.push(jobbean);
//						}
//						jobPicker.setData(jobData);
//					},
//					error: function(xhr, type, errorThrown) {
//						//异常处理；
//						plus.nativeUI.toast('哎哟，出错了，请稍后再试！');
//					}
//				});
//
//			}

//客流详情
			function showOpporDetail(){
				mui('.oppor-scroll').on('tap', '.mui-card', function() {
					var opporId = this.getAttribute("data-opporId");
//					var customerFlow = this.getAttribute("data-customerFlow");
//					alert(customerFlow);
//					获得详情页面
					if(!detailPage){
					    detailPage = plus.webview.getWebviewById('opporDetail');
					}
					  //触发详情页面的show事件
					mui.fire(detailPage,'show',opporId);
					//打开详情页面          
					mui.openWindow({
						id: 'opporDetail',
						show: {
							aniShow: 'pop-in'
						},
						waiting: {
							autoShow: false
						}
					});
				})
			}
		</script>
	</body>

</html>
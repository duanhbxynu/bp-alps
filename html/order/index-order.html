<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link href="../../css/reset.css" rel="stylesheet" />
		<link href="../../css/style.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/order/order.css" />
		<link href="../../css/pull-tips.css" rel="stylesheet" />
		<style>
			.mui-segmented-control-inverted{
				box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.08);
			}
			
		</style>
	</head>

	<body>
		<!--下拉刷新容器-->
		<div class="mui-content orderList">
			<div id="slider" class="mui-slider mui-fullscreen">
				<div class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<div class="mui-scroll">
						<a class="mui-control-item mui-active" id="wholeVehicleItem" data-index="0" data-orderType='wholeVehicle'>整车订单</a>
						<a class="mui-control-item" data-index="1" data-orderType='increment'>增值订单</a>
						<a class="mui-control-item" data-index="2">全部</a>
					</div>
				</div>
				<div class="mui-slider-group">
					<div class="mui-slider-item mui-control-content">
						<div id="pullrefresh" class="mui-scroll-wrapper">
							<div class="mui-scroll mui-scroll-list">
								<div id="cardList"></div>
								<!--<div class="mui-card">
									<div class="mui-card-header">
										订单编号KL092034
									</div>
									<div class="mui-card-content">
										<p class="clearfix"><span>姓名</span><span>李小姐 女</span></p>
										<p class="clearfix"><span>电话</span><span>15236730000</span></p>
										<p class="clearfix"><span>品牌</span><span>奥迪A6</span></p>
										<p class="clearfix"><span>车系</span><span>A4L</span></p>
										<p class="clearfix"><span>车型</span><span>2018-40TFSI运动型-369800</span></p>
										<p class="clearfix"><span>订单类型</span><span class="reds">整车-零售订单</span></p>
										<p class="clearfix"><span>订单状态</span><span>已创建</span></p>
										<p class="clearfix"><span>财务状态</span><span>未收款</span></p>
										<p class="clearfix"><span>车辆状态</span><span>待预留</span></p>
										<p class="clearfix"><span>业务状态</span><span>订单未提交</span></p>
										<p class="clearfix"><span>订单金额</span><span class="reds">298.3万</span></p>
										<p class="clearfix"><span>跟新日期</span><span>2018-06-02 16:27:13</span></p>
									</div>
								</div>

								<div class="mui-card">
									<div class="mui-card-header">
										订单编号KL092034
									</div>
									<div class="mui-card-content">
										<p class="clearfix"><span>姓名</span><span>李小姐 女</span></p>
										<p class="clearfix"><span>电话</span><span>15236730000</span></p>
										<p class="clearfix"><span>品牌</span><span>奥迪A6</span></p>
										<p class="clearfix"><span>车系</span><span>A4L</span></p>
										<p class="clearfix"><span>车型</span><span>2018-40TFSI运动型-369800</span></p>
										<p class="clearfix"><span>订单类型</span><span class="reds">整车-零售订单</span></p>
										<p class="clearfix"><span>订单状态</span><span>已创建</span></p>
										<p class="clearfix"><span>财务状态</span><span>未收款</span></p>
										<p class="clearfix"><span>车辆状态</span><span>待预留</span></p>
										<p class="clearfix"><span>业务状态</span><span>订单未提交</span></p>
										<p class="clearfix"><span>订单金额</span><span class="reds">298.3万</span></p>
										<p class="clearfix"><span>跟新日期</span><span>2018-06-02 16:27:13</span></p>
									</div>
								</div>-->

							</div>
						</div>
					</div>
					<!--<div class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<div class="mui-card">
									<div class="mui-card-header">
										订单编号KL092034
									</div>
									<div class="mui-card-content">
										<p class="clearfix"><span>姓名</span><span>李小姐 女</span></p>
										<p class="clearfix"><span>电话</span><span>15236730000</span></p>
										<p class="clearfix"><span>订单类型</span><span class="reds">整车-零售订单</span></p>
										<p class="clearfix"><span>订单状态</span><span>已创建</span></p>
										<p class="clearfix"><span>财务状态</span><span>未收款</span></p>
										<p class="clearfix"><span>订单金额</span><span class="reds">298.3万</span></p>
										<p class="clearfix"><span>跟新日期</span><span>2018-06-02 16:27:13</span></p>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<div class="mui-card">
									<div class="mui-card-header">
										订单编号KL092034
									</div>
									<div class="mui-card-content">
										<p class="clearfix"><span>姓名</span><span>李小姐 女</span></p>
										<p class="clearfix"><span>电话</span><span>15236730000</span></p>
										<p class="clearfix"><span>订单类型</span><span class="reds">整车-零售订单</span></p>
										<p class="clearfix"><span>订单状态</span><span>已创建</span></p>
										<p class="clearfix"><span>财务状态</span><span>未收款</span></p>
										<p class="clearfix"><span>订单金额</span><span class="reds">298.3万</span></p>
										<p class="clearfix"><span>跟新日期</span><span>2018-06-02 16:27:13</span></p>
									</div>
								</div>
							</div>
						</div>
					</div>
				-->
				</div>
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/mui.pullToRefresh.js"></script>
		<script src="../../js/mui.pullToRefresh.material.js"></script>
		<script src="../../js/common.js"></script>
		<script src="../../js/order/order.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/common/arttmpl.js"></script>
		<script>
			mui.init({
				swipeBack: false,
			});
			var orderType = 'wholeVehicle';
			var incrementDetailPage = null;
			var wholeDetailPage = null;
			document.addEventListener('showType',function(){
				console.log('再次进入');
				mui.trigger(document.getElementById('wholeVehicleItem'), 'tap');
				//切换选项卡高亮
				var current = document.querySelector(".mui-scroll>.mui-control-item.mui-active");
				if (document.getElementById('wholeVehicleItem') !== current) {
					current.classList.remove('mui-active');
					document.getElementById('wholeVehicleItem').classList.add('mui-active');
				}
			})
			//下拉刷新初始化动作	
			if(mui.os.plus) {
				mui.plusReady(function() {

					setTimeout(function() {
						console.log("第一次进入");
						initPullToRefresh();
					}, 1000);
					//预加载页面mui.preload必须放在plusReady事件中
					/*预加载详情页*/
					wholeDetailPage = mui.preload({
						id: 'wholeVehicleOrderDetail',
						url: 'wholeVehicleOrder_detail_result.html'
					})
					/*预加载详情页*/
					incrementDetailPage = mui.preload({
						id: 'incrementOrderDetail',
						url: 'incrementOrder_detail_result.html'
					})

				});
			} else {
				mui.ready(function() {
					initPullToRefresh();
				});
				//				/*预加载详情页*/
				wholeDetailPage = mui.preload({
					id: 'wholeVehicleOrderDetail',
					url: 'wholeVehicleOrder_detail_result.html'

				})
				//				/*预加载详情页*/
				incrementDetailPage = mui.preload({
					id: 'incrementOrderDetail',
					url: 'incrementOrder_detail_result.html'

				})
			}

			function qryOrderList() {
				var params = {
					currentPage: 0,
					pagesize: 10,
					orderType: orderType
				}
				orderjs.qryOrderList(params, function(data) {
					console.log("订单列表");
					console.log(data);
					var data = JSON.parse(data);
					console.log(data);

					console.log("订单列表data.success " + data.success);
					if(data.success) {
						orderList = data.orderList;
						console.log("qryOrderList163=====orderList");
						console.log(orderList);
						console.log(JSON.stringify(orderList));
						return JSON.stringify(orderList);
					} else {

						plus.nativeUI.toast(data.error);
					}
				});
			}

			function createFragment(dataList) {
				console.log(dataList);
				var orderCard = document.body.querySelectorAll('.mui-card-list');
				var listLen = dataList.length;
				var fragment = document.createDocumentFragment();
				for(var i = 0; i < listLen; i++) {
					var card = document.createElement('div');
					card.className = 'mui-card mui-card-list';
					card.setAttribute("data-orderCode", dataList[i].code);
					card.setAttribute("data-creationtime", dataList[i].creationtime);
					card.setAttribute("data-orderType", dataList[i].orderType || orderType);
					var item = "";
					item = '<div class="mui-card-header"><label>订单编号' + dataList[i].code + '</label></div>' +
						'<div class="mui-card-content">' +
						'<p class="clearfix"><span>姓名</span><span>' + dataList[i].customerName + '</span></p>' +
						'<p class="clearfix"><span>电话</span><span>' + dataList[i].customerMobileNumber + '</span></p>';

					var lineItemName = '零售订单';
					if(dataList[i].lineItemName) {
						lineItemName = dataList[i].lineItemName;
					}
					var orderTypeValue = "增值订单";
					if(dataList[i].orderType) {
						if(orderList[i].orderType == 'wholeVehicle') {
							item += '<p class="clearfix"><span>品牌</span><span>' + orderList[i].vehicleBrand + '</span></p>' +
								'<p class="clearfix"><span>车系</span><span>' + orderList[i].vehicle + '</span></p>' +
								'<p class="clearfix"><span>车型</span><span>' + orderList[i].carModel + '</span></p>' +
								'<p class="clearfix"><span>订单类型</span><span class="reds">整车-' + lineItemName + '</span></p>';
						} else {
							item += '<p class="clearfix"><span>订单类型</span><span class="reds">增值订单</span></p>';
						}
					}
					item += '<p class="clearfix"><span>订单状态</span><span>' + dataList[i].orderStatus + '</span></p>' +
						'<p class="clearfix"><span>订单金额</span><span class="reds">' + dataList[i].totalPrice + '</span></p>' +
						'<p class="clearfix"><span>创建时间</span><span>' + dataList[i].creationtime + '</span></p></div>';
					card.innerHTML = item;
					console.log("=============index-order line 233================");
					fragment.appendChild(card);
				}
				return fragment;
			}
			var pullToRefresh = null;
			var count = 0;
			var pagesize = 5;
			var totalPage;

			function initPullToRefresh() {
				pullToRefresh = mui('#pullrefresh .mui-scroll').pullToRefresh({
					down: {
						callback: pulldownRefresh
					},
					up: {
						contentinit: '上拉显示更多', //可以上拉提示信息
						contentdown: '上拉显示更多', //上拉结束提示信息
						contentrefresh: '正在加载...', //上拉进行中提示信息
						contentnomore: '没有更多数据了', //上拉无更多信息时提示信息
						callback: pullupRefresh
					}
				})
				pullToRefresh.pullDownLoading();
			}

			function pullupRefresh() {

				setTimeout(function() {
					console.log("order --- pulluprefresh");
					if(++count > totalPage - 1) {
						pullToRefresh.endPullUpToRefresh(true);
						return;
					} else {
						pullToRefresh.endPullUpToRefresh(false);
					}
					var orderScroll = document.body.querySelector('#cardList');
					var params = {
						currentPage: count,
						pagesize: pagesize,
						orderType: orderType
					}
					orderjs.qryOrderList(params, function(data) {
						console.log("订单列表");
						console.log(data);
						var data = JSON.parse(data);
						console.log(data);
						console.log("订单列表data.success" + data.success);
						if(data.success) {
							orderList = data.orderList;
							console.log(orderList);
							totalPage = data.totalPage;
							if(!orderList) {
								pullToRefresh.endPullUpToRefresh(true);
								return;
							} else {
								orderScroll.appendChild(createFragment(orderList));
								if(totalPage<=1){
									pullToRefresh.endPullUpToRefresh(true);
									return;	
								}
							}
						} else {

							plus.nativeUI.toast(data.error);
						}
					});

					pullToRefresh.refresh(true);
					showOrderDetail();
				}, 500);
			}

			function pulldownRefresh() {

				setTimeout(function() {
					var orderScroll = document.body.querySelector('#cardList');
					var params = {
						currentPage: 0,
						pagesize: pagesize,
						orderType: orderType
					}
					orderjs.qryOrderList(params, function(data) {
						console.log("订单列表");
						console.log(data);
						var data = JSON.parse(data);
						console.log(data);

						console.log("订单列表data.success" + data.success);
						if(data.success) {
							//成功返回数据，
							orderList = data.orderList;
							console.log(orderList);
							//1.清空原ul下的子节点全部清空
							while(orderScroll.hasChildNodes()) {
								console.log('清理列表数据...');
								orderScroll.removeChild(orderScroll.firstChild);
							}
							count = 0;
							//2.将数据前2条填充到列表中
							if(!orderList) {
								pullToRefresh.endPullUpToRefresh(true);
								return;
							} else {
								orderScroll.appendChild(createFragment(orderList));
								if(totalPage<=1){
									pullToRefresh.endPullUpToRefresh(true);
									return;	
								}
							}

						} else if(data.messageCode == '403') { //token过期，重新登录
							plus.nativeUI.toast(data.message);
							common.baseOption.goToLogin();
						} else {
							plus.nativeUI.toast(data.message);
						}
					});
					pullToRefresh.refresh(true);
					pullToRefresh.endPullDownToRefresh();
					showOrderDetail();
				}, 500);
			}

			var itemIndex = 0;
			mui('.mui-scroll-wrapper').scroll({
				bounce: true,
				indicators: true,
				deceleration: mui.os.ios ? 0.003 : 0.0009
			});
			mui('.mui-scroll').on('tap', '.mui-control-item', function() {
				console.log('模拟点击');
				orderType = this.getAttribute('data-orderType');
				console.log(orderType);
				if(orderType == 'increment') {
					mui.fire(plus.webview.getWebviewById('main'), 'addIcon', 'true');
				} else {
					mui.fire(plus.webview.getWebviewById('main'), 'addIcon', 'false');
				}
				count = 0;
				pullToRefresh.pullDownLoading();
			});

			function showOrderDetail() {
				mui('.mui-scroll-wrapper').on('tap', '.mui-card-list', function() {
					var orderCode = this.getAttribute("data-orderCode");
					var creationtime = this.getAttribute("data-creationtime");
					var orderType = this.getAttribute("data-orderType");
					console.log(orderCode);

					if(orderType == 'wholeVehicle') {
						//获得详情页面
						//触发详情页面的show事件
						if(!wholeDetailPage) {
							wholeDetailPage = plus.webview.getWebviewById('wholeVehicleOrderDetail');
						}
						mui.fire(wholeDetailPage, 'showWholeVehicle', {
							creationtime: creationtime,
							orderCode: orderCode
						});
						//打开详情页面          
						mui.openWindow({
							id: 'wholeVehicleOrderDetail'
						});
					} else {
						//触发详情页面的show事件
						if(!incrementDetailPage) {
							incrementDetailPage = plus.webview.getWebviewById('incrementOrderDetail');
						}
						mui.fire(incrementDetailPage, 'show', {
							creationtime: creationtime,
							orderCode: orderCode
						});
						//打开详情页面          
						mui.openWindow({
							id: 'incrementOrderDetail',
							url: 'incrementOrder_detail_result.html'
						});
					}

				})
			}
		</script>
	</body>

</html>
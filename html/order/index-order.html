<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link href="../../css/reset.css" rel="stylesheet" />
		<link href="../../css/style.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/order/order.css" />
	</head>

	<body>
		<!--下拉刷新容器-->
		<div class="mui-content orderList">
			<div id="slider" class="mui-slider mui-fullscreen">
				<div class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<div class="mui-scroll">
						<a class="mui-control-item mui-active" data-index="0" data-orderType='wholeVehicle'>整车订单</a>
						<a class="mui-control-item" data-index="1" data-orderType='increment'>增值订单</a>
						<a class="mui-control-item" data-index="2">全部</a>
					</div>
				</div>
				<div class="mui-slider-group">
					<div class="mui-slider-item mui-control-content">
						<div id="pullrefresh" class="mui-scroll-wrapper">
							<div class="mui-scroll mui-scroll-list">
								<!--<div class="mui-card">
									<div class="mui-card-header">
										订单编号KL092034
									</div>
									<div class="mui-card-content">
										<p class="clearfix"><span>姓名</span><span>李小姐 女</span></p>
										<p class="clearfix"><span>电话</span><span>15236730000</span></p>
										<p class="clearfix"><span>品牌</span><span>奥迪A6</span></p>
										<p class="clearfix"><span>车系</span><span>A4L</span></p>
										<p class="clearfix"><span>车型</span><span>2018-40TFSI运动型-369800</span></p>
										<p class="clearfix"><span>订单类型</span><span class="reds">整车-零售订单</span></p>
										<p class="clearfix"><span>订单状态</span><span>已创建</span></p>
										<p class="clearfix"><span>财务状态</span><span>未收款</span></p>
										<p class="clearfix"><span>车辆状态</span><span>待预留</span></p>
										<p class="clearfix"><span>业务状态</span><span>订单未提交</span></p>
										<p class="clearfix"><span>订单金额</span><span class="reds">298.3万</span></p>
										<p class="clearfix"><span>跟新日期</span><span>2018-06-02 16:27:13</span></p>
									</div>
								</div>

								<div class="mui-card">
									<div class="mui-card-header">
										订单编号KL092034
									</div>
									<div class="mui-card-content">
										<p class="clearfix"><span>姓名</span><span>李小姐 女</span></p>
										<p class="clearfix"><span>电话</span><span>15236730000</span></p>
										<p class="clearfix"><span>品牌</span><span>奥迪A6</span></p>
										<p class="clearfix"><span>车系</span><span>A4L</span></p>
										<p class="clearfix"><span>车型</span><span>2018-40TFSI运动型-369800</span></p>
										<p class="clearfix"><span>订单类型</span><span class="reds">整车-零售订单</span></p>
										<p class="clearfix"><span>订单状态</span><span>已创建</span></p>
										<p class="clearfix"><span>财务状态</span><span>未收款</span></p>
										<p class="clearfix"><span>车辆状态</span><span>待预留</span></p>
										<p class="clearfix"><span>业务状态</span><span>订单未提交</span></p>
										<p class="clearfix"><span>订单金额</span><span class="reds">298.3万</span></p>
										<p class="clearfix"><span>跟新日期</span><span>2018-06-02 16:27:13</span></p>
									</div>
								</div>-->

							</div>
						</div>
					</div>
					<!--<div class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<div class="mui-card">
									<div class="mui-card-header">
										订单编号KL092034
									</div>
									<div class="mui-card-content">
										<p class="clearfix"><span>姓名</span><span>李小姐 女</span></p>
										<p class="clearfix"><span>电话</span><span>15236730000</span></p>
										<p class="clearfix"><span>订单类型</span><span class="reds">整车-零售订单</span></p>
										<p class="clearfix"><span>订单状态</span><span>已创建</span></p>
										<p class="clearfix"><span>财务状态</span><span>未收款</span></p>
										<p class="clearfix"><span>订单金额</span><span class="reds">298.3万</span></p>
										<p class="clearfix"><span>跟新日期</span><span>2018-06-02 16:27:13</span></p>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<div class="mui-card">
									<div class="mui-card-header">
										订单编号KL092034
									</div>
									<div class="mui-card-content">
										<p class="clearfix"><span>姓名</span><span>李小姐 女</span></p>
										<p class="clearfix"><span>电话</span><span>15236730000</span></p>
										<p class="clearfix"><span>订单类型</span><span class="reds">整车-零售订单</span></p>
										<p class="clearfix"><span>订单状态</span><span>已创建</span></p>
										<p class="clearfix"><span>财务状态</span><span>未收款</span></p>
										<p class="clearfix"><span>订单金额</span><span class="reds">298.3万</span></p>
										<p class="clearfix"><span>跟新日期</span><span>2018-06-02 16:27:13</span></p>
									</div>
								</div>
							</div>
						</div>
					</div>
				-->
				</div>
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/mui.pullToRefresh.js"></script>
		<script src="../../js/mui.pullToRefresh.material.js"></script>
		<script src="../../js/common.js"></script>
		<script src="../../js/order/order.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/common/arttmpl.js"></script>
		<script>
			mui.init({
				swipeBack: false,
				pullRefresh: {
					container: '#pullrefresh',
					down: {
						contentdown: "下拉可以刷新", //可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
						contentover: "释放立即刷新", //可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
						contentrefresh: "正在刷新...", //可选，正在刷新状态时，下拉刷新控件上显示的标题内容
						callback: pulldownRefresh
					},
					up: {
						auto: true,
						contentrefresh: '正在加载...',
						contentnomore: '没有更多数据了',
						callback: pullupRefresh
					}
				}
			});

			var count = 0;
			var orderList;
			var orderType = 'wholeVehicle';
			var incrementDetailPage = null;
			var wholeDetailPage = null;

			function qryOrderList() {
				var params = {
					currentPage: 0,
					pagesize: 10,
					orderType: orderType
				}
				
				order.qryOrderList(params, function(data) {
					console.log("订单列表");
					console.log(data);
					var data = JSON.parse(data);
					console.log(data);

					console.log("订单列表data.success" + data.success);
					if(data.success) {
						orderList = data.orderList;
						console.log("qryOrderList163=====orderList");
						console.log(orderList);
						console.log(JSON.stringify(orderList));
						return JSON.stringify(orderList);
					} else {

						plus.nativeUI.toast(data.error);
					}
				});
			}

			function fillingData(pull,orderList) {
				console.log(orderList);
				var orderScroll = document.body.querySelector('.mui-scroll-list');
				var orderCard = document.body.querySelectorAll('.mui-card-list');

				if(pull == "pullup") {
					mui('#pullrefresh').pullRefresh().endPullupToRefresh((++count > Math.ceil(orderList.length / 10))); //参数为true代表没有更多数据了。
				}
				

				var listLen = orderList.length;
				console.log("listLen="+listLen);
				
				var i = orderCard.length;
				var len = null;
				if((i + 10 > listLen) && (i - 10 < listLen)) {
					len = listLen;
				} else {
					len = i + 10;
				}
				console.log(i);
				console.log(len);
				for(; i < len; i++) {
					var card = document.createElement('div');
					card.className = 'mui-card mui-card-list';
					card.setAttribute("data-orderCode", orderList[i].code);
					card.setAttribute("data-creationtime", orderList[i].creationtime);
					var item = "";
					item = '<div class="mui-card-header"><label>订单编号' + orderList[i].code + '</label></div>' +
						'<div class="mui-card-content">' +
						'<p class="clearfix"><span>姓名</span><span>' + orderList[i].customerName + '</span></p>' +
						'<p class="clearfix"><span>电话</span><span>' + orderList[i].customerMobileNumber + '</span></p>';

					var lineItemName = '零售订单';
					if(orderList[i].lineItemName){
						lineItemName = orderList[i].lineItemName;
					}
					var orderTypeValue = "增值订单";
					var orderType="";
					if(orderList[i].orderType){
						if(orderList[i].orderType == 'wholeVehicle'){
							orderTypeValue = '整车订单';
						}else{
							orderTypeValue = '增值订单';
						}
//						orderType = orderList[i].orderType;
					}
					card.setAttribute("data-orderType", orderList[i].code);
//					if(orderList[i].orderType == 'wholeVehicle') {
//						item +='<p class="clearfix"><span>品牌</span><span>' + orderList[i].vehicleBrand + '</span></p>' +
//							'<p class="clearfix"><span>车系</span><span>' + orderList[i].vehicle + '</span></p>' +
//							'<p class="clearfix"><span>车型</span><span>' + orderList[i].carModel + '</span></p>' +
//							'<p class="clearfix"><span>订单类型</span><span class="reds">整车-' + lineItemName + '</span></p>';
//					} else {
//						item +='<p class="clearfix"><span>订单类型</span><span class="reds">增值订单</span></p>';
//					}
					item +='<p class="clearfix"><span>品牌</span><span>' + orderList[i].vehicleBrand + '</span></p>' +
							'<p class="clearfix"><span>车系</span><span>' + orderList[i].vehicle + '</span></p>' +
							'<p class="clearfix"><span>车型</span><span>' + orderList[i].carModel + '</span></p>' +
							'<p class="clearfix"><span>订单类型</span><span class="reds">'+orderType+'-' + lineItemName + '</span></p>';
							
					item +='<p class="clearfix"><span>订单状态</span><span>' + orderList[i].orderStatus + '</span></p>' +
					'<p class="clearfix"><span>订单金额</span><span class="reds">' + orderList[i].totalPrice + '</span></p>'+
					'<p class="clearfix"><span>创建时间</span><span>' + orderList[i].creationtime + '</span></p></div>';
					card.innerHTML = item;
					console.log("=============line 123================");
					console.log(card);
					if(pull == "pullup") {
						console.log("orderScroll.appendChild(card)");
						orderScroll.appendChild(card);
						mui('#pullrefresh').pullRefresh().endPullupToRefresh();
					} else {
						//下拉刷新，新纪录插到最前面；
						console.log("下拉刷新，新纪录插到最前面");
						orderScroll.insertBefore(card, orderScroll.firstChild);
						mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
					}
					showOrderDetail();
					console.log("=============index-order line 232================");
					console.log(orderScroll);
				}
			}

			function pullupRefresh() {

				setTimeout(function() {
					console.log("order --- pulluprefresh");
					var params = {
						currentPage: 0,
						pagesize: 10,
						orderType: orderType
					}
					var orderScroll = document.body.querySelector('.mui-scroll-list');
					order.qryOrderList(params, function(data) {
						console.log("订单列表");
						console.log(data);
						var data = JSON.parse(data);
						console.log(data);
	
						console.log("订单列表data.success" + data.success);
						if(data.success) {
							orderList = data.orderList;
							console.log("qryOrderList252=====orderList");
							console.log(orderList);
							if(!orderList){
								var libDiv = document.createElement('p');
								libDiv.setAttribute("style", "font-size:18px;text-align: center;line-height: 100px;");
								var item = "没有订单";
								libDiv.innerHTML = item;
								orderScroll.appendChild(libDiv);
								mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
								return;
							}else{
								fillingData('pullup',orderList);
							}
						} else {
	
							plus.nativeUI.toast(data.error);
						}
					});
//					fillingData('pullup', orderList);
					mui('#pullrefresh').pullRefresh().refresh(true);
					
					
				}, 500);
			}

			function pulldownRefresh() {

				setTimeout(function() {
//					var orderList = qryOrderList();
					var params = {
						currentPage: 0,
						pagesize: 10,
						orderType: orderType
					}
					var orderScroll = document.body.querySelector('.mui-scroll-list');
					order.qryOrderList(params, function(data) {
						console.log("订单列表");
						console.log(data);
						var data = JSON.parse(data);
						console.log(data);
	
						console.log("订单列表data.success" + data.success);
						if(data.success) {
							orderList = data.orderList;
							console.log(JSON.stringify(orderList));
							//1.清空原scroll下的子节点全部清空
							while(orderScroll.hasChildNodes()) {
								console.log('清理列表数据...');
								orderScroll.removeChild(orderScroll.firstChild);
							}
							
							if(!orderList){
								var libDiv = document.createElement('p');
								libDiv.setAttribute("style", "font-size:18px;text-align: center;line-height: 100px;");
								var item = "没有订单";
								libDiv.innerHTML = item;
									//下拉刷新，新纪录插到最前面；
								console.log("下拉刷新，新纪录插到最前面");
								orderScroll.insertBefore(libDiv, orderScroll.firstChild);
								mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
								return;
							}else{
								fillingData('pulldown',orderList);
							}
							
						} else {
	
							plus.nativeUI.toast(data.error);
						}
					});
					showOrderDetail();
				}, 500);
			}

			var itemIndex = 0;
				mui('.mui-scroll-wrapper').scroll({
					bounce: true,
					indicators: true,
					deceleration: mui.os.ios ? 0.003 : 0.0009
				});
				mui('.mui-scroll').on('tap', '.mui-control-item', function() {
//					itemIndex = this.getAttribute('data-index');
					
					orderType = this.getAttribute('data-orderType');
					console.log(orderType);
//					mui('.mui-slider').slider().gotoItem(this.getAttribute('data-index'));
					mui('#pullrefresh').pullRefresh().pulldownLoading();
					pulldownRefresh();
				});


			//下拉刷新初始化动作	
			if(mui.os.plus) {
				mui.plusReady(function() {

					setTimeout(function() {
						mui('#pullrefresh').pullRefresh().pullupLoading();
						console.log("第一次进入");
					}, 1000);
					//预加载页面mui.preload必须放在plusReady事件中
					wholeDetailPage = mui.preload({
	                    id: 'wholeVehicleOrderDetail',
						url: 'wholeVehicleOrder_detail_result.html'
	                });;
	                incrementDetailPage = mui.preload({
	                    id: 'incrementOrderDetail',
						url: 'incrementOrder_detail_result.html'
	                });
					showOrderDetail();

				});
			} else {
				mui.ready(function() {
					mui('#pullrefresh').pullRefresh().pullupLoading();
					wholeDetailPage = mui.preload({
	                    id: 'wholeVehicleOrderDetail',
						url: 'wholeVehicleOrder_detail_result.html'
	                });;
	                incrementDetailPage = mui.preload({
	                    id: 'incrementOrderDetail',
						url: 'incrementOrder_detail_result.html'
	                });
				});
				/*预加载详情页*/

				showOrderDetail();
			}

			function showOrderDetail() {
				mui('.mui-scroll-wrapper').on('tap', '.mui-card-list', function() {
					var orderCode = this.getAttribute("data-orderCode");
					var creationtime = this.getAttribute("data-creationtime");
					console.log(orderCode);
					
					var jsonvalue = {orderCode:orderCode};
					mui.ajax({
						url: serviceBaseUrl+"alpssalewebservices/order/detail",
						type: "POST",
						dataType: "json",
						contentType: 'application/json',
						data: JSON.stringify(jsonvalue),
						beforeSend: function(xhr) {
							xhr.setRequestHeader("Authorization", "Bearer " + common.baseOption.getToken());
						},
						success: function(data) {
							if(data.success){
								console.log("order detail result:" + JSON.stringify(data));
								var	order = data.order;
								console.log("--------------------------------------------------------------");
								console.log(order);
								console.log(order.orderType);
								if(order.orderType == 'wholeVehicle'){
									//获得详情页面
									  //触发详情页面的show事件
									if(!wholeDetailPage){
										wholeDetailPage = plus.webview.getWebviewById('wholeVehicleOrderDetail');
									}
									mui.fire(plus.webview.getWebviewById('wholeVehicleOrderDetail'),'showWholeVehicle',{
										creationtime:creationtime,
										order:order
									});
									//打开详情页面          
									mui.openWindow({
										id: 'wholeVehicleOrderDetail',
										url: 'wholeVehicleOrder_detail_result.html'
									});
								}else{
									//获得详情页面
									if(!incrementDetailPage){
										incrementDetailPage = plus.webview.getWebviewById('incrementOrderDetail');
									}
									  //触发详情页面的show事件
									mui.fire(plus.webview.getWebviewById('incrementOrderDetail'),'show',{
										creationtime:creationtime,
										order:order
									});
									//打开详情页面          
									mui.openWindow({
										id: 'incrementOrderDetail',
										url: 'incrementOrder_detail_result.html'
									});
								}
								
							}else{
								plus.nativeUI.toast(data.message);
								return;
							}
							
						}
					})
					
				})
			}
		</script>
	</body>
</html>